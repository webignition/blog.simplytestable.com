---
layout: default
title: "Switching From Apache To Nginx on Ubuntu Server"
date: 2012-10-17 15:30
author:
    name: Jon Cram
    url: http://webignition.net
illustration:
    url: http://i.imgur.com/25IpV.png 
    height: 240px
---

<div class="section">
    <p>
        We're changing the web server Simply Testable uses from Apache to Nginx.
    </p>

    <p>
        Why? The straightforward reason is that we have many, many concurrent
        web requests to handle, often over 100 concurrent requests. Nginx uses
        less server resource to cope with this load than Apache.
    </p>  
    
    <p>
        The Simply Testable system uses a collection of Symfony applications
        and a local install of the W3C validator.
    </p>
    
    <p>
        Here's how I migrated our production server from Apache to Nginx without
        any downtime. If you have an Ubuntu server running a comparable set of
        applications, this is one way to go about it.
    </p>
    
    <h2>Keeping Some Applications (W3C Validator) on Apache</h2>
    
    <p>
        We can't ditch Apache just yet. The W3C HTML validator uses quite a specific
        Apache configuration that I haven't, as yet, managed to replicate under
        Nginx.
    </p>
    
    <p>
        That's not a problem, we can still use Apache to run the W3C HTML validator
        so long as it runs on a different port to Nginx. Nginx will run on the
        default HTTP port of 80, so we're going to switch the HTML validator to
        accept requests on port 8090. Anything other than 80 that's not being
        used will do fine.
    </p>
    
    <p>
        To get Apache listening on the correct port ,edit <code>/etc/apache2/ports.conf</code> and add in:
    </p>
    
    <pre>NameVirtualHost *:8090
Listen 8090</pre>
    
    <p>
        And then to get your relevant vhost using that port, edit the relevant
        vhost record in <code>/etc/apache2/sites-available</code>, changing
        <code>&lt;VirtualHost *:80&gt;</code> to <code>&lt;VirtualHost *:8090&gt;</code>.
    </p>
    
    <p>
        Don't forget to test that the relevant application now works on the new port!        
    </p>
    
    <p>
        If you're using a firewall (you are, aren't you?), make sure the new port
        is open to requests if that's what you want.
    </p>
    
    <p>
        If you're using the ufw iptables interface: <code>sudo ufw allow 8090/tcp</code>.
    </p>
    
    <h2>Installing Nginx</h2>
    
    <p>
        Nginx defers handling of PHP requests (or indeed any non-static content)
        to whatever service you tell it to.
    </p>
    
    <p>
        We're going to use <a href="http://php-fpm.org/">php-fpm</a> for handling
        PHP processes, the de-facto standard when using Nginx.
    </p>
    
    <p>
        Install both nginx and php-fpm packages:
    </p>
    
    <pre>sudo apt-get install nginx php5-fpm</pre>
    
    <h2>Setting up Nginx Vhosts Alongside Apache</h2>
    
    <p>
        We don't want any downtime, right? To achieve this, we're going to have
        to set up under Nginx all the vhosts we want to migrate from Apache.
    </p>
    
    <p>
        I'm going to initially run all the Nginx vhosts on port 81 and only when
        that's all working nicely switch over to port 80.
    </p>
    
    <p>
        You need to jiggle things a bit to get the production URLs that Symfony
        expects. Here's an example vhost for one of the workers from <code>/etc/nginx/sites-available/lithium.worker.simplytestable.com.conf</code>:
    </p>
    
    <pre>server {
  listen 81;
 
  server_name lithium.worker.simplytestable.com;
  root /var/www/lithium.worker.simplytestable.com/web;
 
  error_log /var/log/nginx/lithium.worker.simplytestable.com.error.log;
  access_log /var/log/nginx/lithium.worker.simplytestable.com.access.log;
 
  # strip app.php/ prefix if it is present
  rewrite ^/app\.php/?(.*)$ /$1 permanent;
 
  location / {
    index app.php;
    try_files $uri @rewriteapp;
  }
 
  location @rewriteapp {
    rewrite ^(.*)$ /app.php/$1 last;
  }
 
  # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
  location ~ ^/(app|app_dev)\.php(/|$) {
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_split_path_info ^(.+\.php)(/.*)$;
    include fastcgi_params;
    fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
    fastcgi_param  HTTPS              off;
  }
}</pre>
    
    <p>
        Once you've created a vhost, you need to enable it in Nginx and then
        tell Nginx to reload its configuration. Enabling involves symlinking the
        vhost configuration in <code>/etc/nginx/sites-available</code> to <code>/etc/nginx/sites-enabled</code>
    </p>
    
    <pre>ln -s /etc/nginx/sites-available/simplytestable.com.conf /etc/nginx/sites-enabled/simplytestable.com.conf
/etc/nginx/sites-available</pre>
    
    <p>
        As before, check after you enable a vhost that it works, and make sure
        your firewall is accepting connections on the port the vhost is using.
    </p>
    
    <p>
        Once you're done, you should have all the sites you want running under Nginx
        to be actually running under Nginx, temporarily on port 81.
    </p>
    
    <h2>Switching From Apache to Nginx</h2>
    
    <p>
        We want to disable all sites running under Apache on port 80 and have all
        sites running under Nginx to be served on port 80.
    </p>
    
    <p>
        Given that vhost configuration changes for both Apache and Nginx are not
        brought into play until we tell the relevant web server to reload, this
        should be pretty straightforward.
    </p>
    
    <ol>
        <li>
            <p>Update Nginx vhosts to use port 80</p>
        </li>
        <li>
            <p>Disable all Apache vhosts that are using port 80</p>
        </li>               
        <li>
            <p>Reload Apache config</p>
        </li>
        <li>
            <p>Reload Nginx config</p>
        </li>        
    </ol>
    
    <p>
        We're going to have a tiny amount of before the Nginx config is reloaded.
        It should be insignificant.
    </p>
    
    <p>
        Go on, do it.
    </p>
        
    <h2>
        Epilogue
    </h2>

    <p>
        The change didn't go quite as smoothly as I'd hoped.
    </p>    
    
    <p>
        The Nginx vhost for 
        simplytestable.com wasn't configured correctly, preventing Nginx from starting correctly. 
        It took a bit of trial and error to spot this but once spotted things
        worked perfectly until they broke.
    </p>
    
    <p>
        The default php-fpm configuration allows for up to 10 child processes
        at once. This is conceptually the same as the limit on the number of processes
        Apache might be allowed to use.
    </p>
    
    <p>
        The php-fpm logs drew attention to this fact when things ground to halt
        running a handful of concurrent full-site tests. Editing <code>/etc/php5/fpm/pool.d/www.conf</code>
        and setting <code>pm.max_children = 50</code> sorted that out.
    </p>
        
    <h2>
        Was it Worth it?
    </h2>

    <p>
        Yes.
    </p>    
    
    <p>
        Definitely yes.
    </p>
    
    <p>
        Server load under Apache was 30 for 4 concurrent tests. Server load under
        Nginx for 4 concurrent tests is 3. That's an order of magnitude better.
    </p>
    
    <p>
        Server load under Nginx for 20 concurrent tests peaked at about 14 with
        tests still completing smoothly. Under Apache, 20 concurrent tests
        caused a server load of about 80, brought the server to its knees and 
        slowed all tests down significantly.
    </p>
    
    <p>
        So, yes, it was worth it.
    </p>
    
</div>